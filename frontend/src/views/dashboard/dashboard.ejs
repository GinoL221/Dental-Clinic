<!DOCTYPE html>
<html lang="es">
<%- include('../partials/head') %>

<body>
  <%- include('../partials/header') %>

  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <!-- Título del Dashboard -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="h3 mb-0">
            <i class="bi bi-speedometer2 text-primary me-2"></i>
            Dashboard
          </h2>
          <small class="text-muted">
            <i class="bi bi-calendar3"></i>
            <span id="current-date"></span>
          </small>
        </div>

        <!-- Tarjetas de Estadísticas -->
        <div class="row mb-4" id="stats-cards">
          <!-- Loading state -->
          <div class="col-12 text-center" id="loading-stats">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando estadísticas...</span>
            </div>
            <p class="mt-2 text-muted">Cargando datos del dashboard...</p>
          </div>
        </div>

        <!-- Sección de Gráficos y Próximas Citas -->
        <div class="row">
          <!-- Gráfico de Citas por Mes -->
          <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-bottom">
                <h5 class="card-title mb-0">
                  <i class="bi bi-bar-chart-line text-info me-2"></i>
                  Citas por Mes
                </h5>
              </div>
              <div class="card-body">
                <div id="loading-chart" class="text-center py-4">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Cargando gráfico...</span>
                  </div>
                </div>
                <canvas id="appointmentsChart" style="display: none; max-height: 350px;"></canvas>
              </div>
            </div>
          </div>

          <!-- Próximas Citas -->
          <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-bottom">
                <h5 class="card-title mb-0">
                  <i class="bi bi-clock text-warning me-2"></i>
                  Próximas Citas
                </h5>
              </div>
              <div class="card-body p-0">
                <div id="loading-appointments" class="text-center py-4">
                  <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Cargando citas...</span>
                  </div>
                </div>
                <div id="upcoming-appointments" style="display: none; max-height: 350px; overflow-y: auto;">
                  <!-- Las citas se cargarán aquí -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje de Error -->
        <div id="error-message" class="alert alert-danger" style="display: none;">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span id="error-text"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Inicialización mínima de variables globales (solo datos dinámicos)
    window.serverData = {
      user: {
        id: "<%= user.id || '' %>",
        firstName: "<%= user.firstName || '' %>",
        lastName: "<%= user.lastName || '' %>",
        email: "<%= user.email || '' %>",
        role: "<%= user.role || '' %>"
      },
      isAdmin: "<%= isAdmin ? 'true' : 'false' %>",
      currentPage: 'dashboard'
    };
    window.currentUser = window.serverData.user;
    window.isAdmin = window.serverData.isAdmin;
  </script>
  <script type="module" src="/js/dashboard/dashboard-globals.js"></script>

  <script type="module" src="/js/api/config.js"></script>
  <script type="module" src="/js/api/utils.js"></script>
  <script type="module" src="/js/dashboard/dashboard-api.js"></script>
  <script type="module" src="/js/dashboard/dashboard-controller.js"></script>
</body>

</html>
