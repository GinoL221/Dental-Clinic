<!DOCTYPE html>
<html lang="es">
  <%- include('../partials/head') %>

  <body>
    <%- include('../partials/header') %>

    <main class="main-content auth-page">
      <div class="container-fluid">
        <div class="auth-container">
          <div class="auth-card">
            <div class="auth-header">
              <h2 class="auth-title">Editar Cita</h2>
              <p class="auth-subtitle">
                Modificar información de la cita médica
              </p>
            </div>

            <div id="loading" class="text-center p-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-2">Cargando datos de la cita...</p>
            </div>

            <div
              id="error-loading"
              class="alert alert-danger"
              style="display: none"
            >
              <strong>Error:</strong> No se pudo cargar la información de la
              cita.
              <br />
              <a href="/appointments" class="btn btn-outline-primary mt-2">
                ← Volver a la lista de citas
              </a>
            </div>

            <form
              id="edit_appointment_form"
              class="auth-form"
              style="display: none"
            >
              <input type="hidden" id="appointmentId" name="appointmentId" />

              <!-- Campo para seleccionar paciente -->
              <div class="mb-3">
                <label for="patientSelect" class="form-label">
                  <i class="bi bi-person-fill me-1"></i>
                  Paciente
                </label>
                <select
                  class="form-control auth-input"
                  id="patientSelect"
                  name="patientId"
                  required
                >
                  <option value="">Seleccione un paciente</option>
                </select>
              </div>

              <!-- Información legible del paciente (se llena desde JS) -->
              <div id="patientInfoFields" class="mb-3" style="display:none; gap:8px;">
                <div class="row">
                  <div class="col-md-4">
                    <label class="form-label">Nombre</label>
                    <input id="patientFirstName" class="form-control" readonly />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Apellido</label>
                    <input id="patientLastName" class="form-control" readonly />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Email</label>
                    <input id="patientEmail" class="form-control" readonly />
                  </div>
                </div>
              </div>

              <!-- Información del dentista y fecha en la misma fila -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="dentistId" class="form-label">
                    <i class="bi bi-person-badge me-1"></i>
                    Odontólogo
                  </label>
                  <select
                    class="form-control auth-input"
                    id="dentistId"
                    name="dentistId"
                    required
                  >
                    <option value="">Seleccione un odontólogo</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="appointmentDate" class="form-label">
                    <i class="bi bi-calendar3 me-1"></i>
                    Fecha
                  </label>
                  <input
                    type="date"
                    class="form-control auth-input"
                    id="appointmentDate"
                    name="appointmentDate"
                    required
                  />
                </div>
              </div>

              <!-- Hora en una fila separada -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="appointmentTime" class="form-label">
                    <i class="bi bi-clock me-1"></i>
                    Hora
                  </label>
                  <input
                    type="time"
                    class="form-control auth-input"
                    id="appointmentTime"
                    name="appointmentTime"
                    required
                  />
                </div>
              </div>

              <!-- Descripción -->
              <div class="mb-3">
                <label for="description" class="form-label">
                  <i class="bi bi-file-text me-1"></i>
                  Descripción / Motivo
                </label>
                <textarea
                  class="form-control auth-input"
                  id="description"
                  name="description"
                  rows="3"
                  placeholder="Ingrese el motivo de la consulta"
                ></textarea>
              </div>

              <!-- Botones de acción -->
              <div class="d-flex gap-3 mb-3">
                <button
                  type="submit"
                  class="btn auth-btn-primary flex-fill"
                  id="btn-update-appointment"
                >
                  <i class="bi bi-check-circle me-1"></i>
                  Actualizar Cita
                </button>
                <a
                  href="/appointments"
                  class="btn auth-btn-secondary flex-fill"
                >
                  <i class="bi bi-x-circle me-1"></i>
                  Cancelar
                </a>
              </div>

              <div class="auth-footer text-center">
                <p>
                  <a href="/appointments" class="auth-link">
                    <i class="bi bi-arrow-left me-1"></i>
                    Volver a la lista de citas
                  </a>
                </p>
              </div>
            </form>

            <div id="response" class="mt-3" style="display: none"></div>
          </div>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Variables globales del servidor para el controlador de citas
      window.serverData = {
        user: {
          id: '<%= user.id %>',
          firstName: '<%= user.firstName %>',
          lastName: '<%= user.lastName %>',
          email: '<%= user.email %>',
          role: '<%= user.role %>'
        },
        isAdmin: <%- user.role === 'ADMIN' ? 'true' : 'false' %>,
        appointmentId: '<%= appointmentId %>'
      };

      // Variables globales para compatibilidad
      window.currentUser = window.serverData.user;
      window.isAdmin = window.serverData.isAdmin;

      // Configurar evento para mostrar información del paciente seleccionado
      document.addEventListener('DOMContentLoaded', function() {
        const patientSelect = document.getElementById('patientSelect');
        const patientInfoFields = document.getElementById('patientInfoFields');

        if (patientSelect && patientInfoFields) {
          patientSelect.addEventListener('change', function() {
            if (this.value) {
              // Mostrar campos de información del paciente
              patientInfoFields.style.display = 'flex';

              // Extraer información del texto de la opción seleccionada
              const selectedOption = this.options[this.selectedIndex];
              const patientText = selectedOption.textContent;
              const parts = patientText.split(' - ');
              const nameParts = parts[0].trim().split(' ');

              // Llenar campos de solo lectura (compatibilidad con ambos nombres de campo)
              const firstName = nameParts[0] || '';
              const lastName = nameParts.slice(1).join(' ') || '';

              const patientFirstNameEl = document.getElementById('patientFirstName');
              const patientNameEl = document.getElementById('patientName');
              const patientLastNameEl = document.getElementById('patientLastName');
              const patientEmailEl = document.getElementById('patientEmail');

              if (patientFirstNameEl) patientFirstNameEl.value = firstName;
              if (patientNameEl) patientNameEl.value = `${firstName} ${lastName}`.trim();
              if (patientLastNameEl) patientLastNameEl.value = lastName;
              if (patientEmailEl) patientEmailEl.value = parts[1] || '';
            } else {
              // Ocultar campos si no hay selección
              patientInfoFields.style.display = 'none';
            }
          });
        }
      });
    </script>

    <!-- APIs y configuración -->
    <script type="module" src="/js/api/config.js"></script>
    <script type="module" src="/js/api/utils.js"></script>
    <script type="module" src="/js/api/dentist-api.js"></script>
    <script type="module" src="/js/api/appointment-api.js"></script>

    <!-- Configuración específica de página -->
    <script src="/js/appointment/appointment-edit-page.js"></script>

    <!-- Controlador principal modular -->
    <script
      type="module"
      src="/js/appointment/appointment-controller.js"
    ></script>
  </body>
</html>
