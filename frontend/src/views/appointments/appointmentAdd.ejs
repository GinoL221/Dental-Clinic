<!DOCTYPE html>
<html lang="es">
  <%- include('../partials/head') %>

  <body>
    <%- include('../partials/header') %>

    <main class="main-content auth-page">
      <div class="container-fluid">
        <div class="auth-container">
          <div class="auth-card">
            <div class="auth-header">
              <h2 class="auth-title">Agregar Cita</h2>
              <p class="auth-subtitle">Programar una nueva cita médica</p>
            </div>

            <form id="add_new_appointment" class="auth-form">
              <!-- Campo para seleccionar paciente (usuarios) -->
              <div class="mb-3">
                <label for="patientSelect" class="form-label"
                  >Seleccionar Paciente</label
                >
                <select
                  class="form-control auth-input"
                  id="patientSelect"
                  name="patientId"
                  required
                >
                  <option value="">Seleccione un paciente</option>
                </select>
                <small class="form-text text-muted"
                  >Seleccione el usuario que será el paciente para esta
                  cita.</small
                >
              </div>

              <!-- Información legible del paciente (se llena desde JS) -->
              <div id="patientInfoFields" class="mb-3" style="display:none; gap:8px;">
                <div class="row">
                  <div class="col-md-4">
                    <label class="form-label">Nombre</label>
                    <input id="patientFirstName" class="form-control" readonly />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Apellido</label>
                    <input id="patientLastName" class="form-control" readonly />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Email</label>
                    <input id="patientEmail" class="form-control" readonly />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="dentistId" class="form-label">Odontólogo</label>
                  <select
                    class="form-control auth-input"
                    id="dentistId"
                    name="dentistId"
                    required
                  >
                    <option value="">Seleccione un odontólogo</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="appointmentDate" class="form-label">Fecha</label>
                  <input
                    type="date"
                    class="form-control auth-input"
                    id="appointmentDate"
                    name="appointmentDate"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="appointmentTime" class="form-label">Hora</label>
                  <input
                    type="time"
                    class="form-control auth-input"
                    id="appointmentTime"
                    name="appointmentTime"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label"
                  >Descripción / Motivo</label
                >
                <textarea
                  class="form-control auth-input"
                  id="description"
                  name="description"
                  rows="3"
                  placeholder="Ingrese el motivo de la consulta"
                ></textarea>
              </div>

              <button
                type="submit"
                class="btn auth-btn-primary w-100 mb-3"
                id="btn-add-new-appointment"
              >
                <% if (user.role === 'ADMIN') { %> Programar Cita para Paciente
                <% } else { %> Solicitar Mi Cita <% } %>
              </button>

              <div class="auth-footer">
                <p>
                  <a href="/appointments" class="auth-link"
                    >← Volver a la lista de citas</a
                  >
                </p>
              </div>
            </form>

            <div id="response" class="mt-3" style="display: none"></div>
          </div>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Variables globales del servidor para el controlador de citas
      window.serverData = {
        user: {
          id: '<%= user.id %>',
          firstName: '<%= user.firstName %>',
          lastName: '<%= user.lastName %>',
          email: '<%= user.email %>',
          role: '<%= user.role %>'
        },
        isAdmin: <%- user.role === 'ADMIN' ? 'true' : 'false' %>,
        appointmentId: null
      };

      // Variables globales para compatibilidad
      window.currentUser = window.serverData.user;
      window.isAdmin = window.serverData.isAdmin;
    </script>

    <script type="module" src="/js/api/config.js"></script>
    <script type="module" src="/js/api/utils.js"></script>
    <script type="module" src="/js/api/dentist-api.js"></script>
    <script type="module" src="/js/api/patient-api.js"></script>
    <script type="module" src="/js/api/appointment-api.js"></script>

    <!-- Controlador de Citas -->
    <script
      type="module"
      src="/js/appointment/appointment-controller.js"
    ></script>
  </body>
</html>
